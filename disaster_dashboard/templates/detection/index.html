{% extends 'base.html' %}

{% block title %}Object Detection - Vihangam AI Vision{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="display-6 fw-bold text-primary">
                    <i class="fas fa-eye me-2"></i>AI Object Detection System
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="start-detection-btn">
                        <i class="fas fa-play me-1"></i>Start Detection
                    </button>
                    <button class="btn btn-danger" id="stop-detection-btn" disabled>
                        <i class="fas fa-stop me-1"></i>Stop Detection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detection Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Objects Detected</h6>
                            <h2 class="fw-bold" id="objects-count">247</h2>
                            <small><i class="fas fa-clock me-1"></i>Last hour</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-search fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">High Priority</h6>
                            <h2 class="fw-bold" id="priority-count">12</h2>
                            <small><i class="fas fa-exclamation-triangle me-1"></i>Require attention</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Detection Accuracy</h6>
                            <h2 class="fw-bold">94.2%</h2>
                            <small><i class="fas fa-arrow-up me-1"></i>+2.1% today</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bullseye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Processing Speed</h6>
                            <h2 class="fw-bold">28 FPS</h2>
                            <small><i class="fas fa-tachometer-alt me-1"></i>Real-time</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bolt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Detection Content -->
    <div class="row">
        <!-- Live Detection Feed -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-video me-2"></i>Live Detection Feed
                    </h5>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge bg-success" id="detection-status">ACTIVE</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary">Drone Alpha</button>
                            <button class="btn btn-outline-primary">Drone Beta</button>
                            <button class="btn btn-outline-primary">Drone Gamma</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="detection-container bg-dark d-flex align-items-center justify-content-center position-relative" style="height: 450px;">
                        <div class="text-center text-light" id="default-message">
                            <i class="fas fa-eye fa-3x mb-3"></i>
                            <p>AI Detection processing will appear here</p>
                            <small>YOLO model analyzing live feed...</small>
                        </div>
                        
                        <!-- Image Upload Area -->
                        <div class="text-center text-light d-none" id="upload-area">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                            <p>Upload an image for YOLO detection</p>
                            <input type="file" class="d-none" id="image-upload" accept="image/*">
                            <button class="btn btn-primary" onclick="document.getElementById('image-upload').click()">
                                <i class="fas fa-upload me-2"></i>Choose Image
                            </button>
                        </div>
                        
                        <!-- Detection Results Display -->
                        <canvas id="detection-canvas" class="w-100 h-100 d-none"></canvas>
                        
                        <!-- Detection Overlay for bounding boxes -->
                        <div class="detection-overlay position-absolute top-0 start-0 w-100 h-100" id="detection-overlay">
                            <!-- Bounding boxes will be dynamically added here -->
                        </div>
                        
                        <!-- Processing indicator -->
                        <div class="processing-indicator position-absolute top-50 start-50 translate-middle d-none" id="processing-indicator">
                            <div class="spinner-border text-light" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <p class="text-light mt-2">Processing with YOLO...</p>
                        </div>
                    </div>
                    
                    <!-- Detection Controls -->
                    <div class="mt-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label class="form-label me-2 mb-0">Confidence Threshold:</label>
                                    <input type="range" class="form-range flex-grow-1 me-2" id="confidence-slider" min="0" max="100" value="75">
                                    <span class="badge bg-secondary" id="confidence-value">75%</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="btn-group btn-group-sm w-100">
                                    <button class="btn btn-outline-primary" id="upload-mode-btn">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                    <button class="btn btn-outline-secondary" id="live-mode-btn">
                                        <i class="fas fa-video"></i> Live
                                    </button>
                                    <button class="btn btn-outline-success" id="process-btn" disabled>
                                        <i class="fas fa-play"></i> Process
                                    </button>
                                    <button class="btn btn-outline-secondary">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detection Settings & Results -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Detection Settings
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Model Selection -->
                    <div class="mb-4">
                        <h6 class="fw-bold">AI Model</h6>
                        <select class="form-select" id="model-select">
                            <option value="yolov8n.pt" selected>YOLOv8n - Nano (fastest)</option>
                            <option value="yolov8s.pt">YOLOv8s - Small</option>
                            <option value="yolov8m.pt">YOLOv8m - Medium</option>
                            <option value="yolov8l.pt">YOLOv8l - Large</option>
                            <option value="yolov8x.pt">YOLOv8x - Extra Large</option>
                        </select>
                    </div>

                    <!-- Detection Classes -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Object Classes</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="person" checked>
                            <label class="form-check-label" for="person">Person</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vehicle" checked>
                            <label class="form-check-label" for="vehicle">Vehicle</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="building">
                            <label class="form-check-label" for="building">Building</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="debris" checked>
                            <label class="form-check-label" for="debris">Debris</label>
                        </div>
                    </div>

                    <!-- Alert Settings -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Alert Settings</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-alerts" checked>
                            <label class="form-check-label" for="auto-alerts">Auto Alerts</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="priority-only">
                            <label class="form-check-label" for="priority-only">High Priority Only</label>
                        </div>
                    </div>

                    <!-- Current Detections -->
                    <div>
                        <h6 class="fw-bold">Recent Detections</h6>
                        <div class="detection-list" style="max-height: 200px; overflow-y: auto;">
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div>
                                    <small class="fw-bold text-warning">Person</small><br>
                                    <small class="text-muted">Conf: 89%</small>
                                </div>
                                <small class="text-muted">18:04:12</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div>
                                    <small class="fw-bold text-info">Vehicle</small><br>
                                    <small class="text-muted">Conf: 92%</small>
                                </div>
                                <small class="text-muted">18:03:45</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div>
                                    <small class="fw-bold text-danger">Debris</small><br>
                                    <small class="text-muted">Conf: 76%</small>
                                </div>
                                <small class="text-muted">18:02:33</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div>
                                    <small class="fw-bold text-warning">Person</small><br>
                                    <small class="text-muted">Conf: 94%</small>
                                </div>
                                <small class="text-muted">18:01:21</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detection Analytics -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Detection Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Chart placeholder -->
                            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                                    <p>Detection frequency chart would appear here</p>
                                    <small>Real-time analytics visualization</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">Object Summary</h6>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Persons</span>
                                    <span class="fw-bold text-warning">87</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 60%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Vehicles</span>
                                    <span class="fw-bold text-info">43</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" style="width: 30%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Debris</span>
                                    <span class="fw-bold text-danger">23</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-danger" style="width: 16%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Buildings</span>
                                    <span class="fw-bold text-success">12</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 8%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced YOLO Detection JavaScript
class VihangamDetection {
    constructor() {
        this.websocket = null;
        this.isLiveDetection = false;
        this.currentMode = 'live'; // 'live' or 'upload'
        this.confidenceThreshold = 0.75;
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.connectWebSocket();
    }
    
    setupEventListeners() {
        // Main control buttons
        document.getElementById('start-detection-btn').addEventListener('click', () => {
            if (this.currentMode === 'live') {
                this.startLiveDetection();
            } else {
                this.processUploadedImage();
            }
        });
        
        document.getElementById('stop-detection-btn').addEventListener('click', () => {
            this.stopLiveDetection();
        });
        
        // Mode switching
        document.getElementById('upload-mode-btn').addEventListener('click', () => {
            this.switchToUploadMode();
        });
        
        document.getElementById('live-mode-btn').addEventListener('click', () => {
            this.switchToLiveMode();
        });
        
        // Image upload
        document.getElementById('image-upload').addEventListener('change', (e) => {
            this.handleImageUpload(e.target.files[0]);
        });
        
        document.getElementById('process-btn').addEventListener('click', () => {
            this.processUploadedImage();
        });
        
        // Confidence threshold
        document.getElementById('confidence-slider').addEventListener('input', (e) => {
            this.confidenceThreshold = e.target.value / 100;
            document.getElementById('confidence-value').textContent = e.target.value + '%';
        });
        
        // Model selection
        document.getElementById('model-select').addEventListener('change', (e) => {
            this.switchModel(e.target.value);
        });
    }
    
    connectWebSocket() {
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsPath = `${wsScheme}://${window.location.host}/ws/detection/`;
        
        this.websocket = new WebSocket(wsPath);
        
        this.websocket.onopen = () => {
            console.log('WebSocket connected to Vihangam Detection System');
        };
        
        this.websocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleWebSocketMessage(data);
        };
        
        this.websocket.onclose = () => {
            console.log('WebSocket connection closed');
            // Attempt to reconnect after 5 seconds
            setTimeout(() => this.connectWebSocket(), 5000);
        };
        
        this.websocket.onerror = (error) => {
            console.error('WebSocket error:', error);
        };
    }
    
    handleWebSocketMessage(data) {
        switch (data.type) {
            case 'detection_started':
                this.onDetectionStarted(data);
                break;
            case 'detection_stopped':
                this.onDetectionStopped(data);
                break;
            case 'detection_update':
                this.updateDetectionResults(data.data);
                break;
            case 'model_info':
                this.displayModelInfo(data.model_info);
                break;
            case 'error':
                this.showError(data.message);
                break;
        }
    }
    
    switchToUploadMode() {
        this.currentMode = 'upload';
        document.getElementById('default-message').classList.add('d-none');
        document.getElementById('upload-area').classList.remove('d-none');
        document.getElementById('upload-mode-btn').classList.replace('btn-outline-primary', 'btn-primary');
        document.getElementById('live-mode-btn').classList.replace('btn-primary', 'btn-outline-secondary');
        document.getElementById('start-detection-btn').textContent = 'Process Image';
    }
    
    switchToLiveMode() {
        this.currentMode = 'live';
        document.getElementById('upload-area').classList.add('d-none');
        document.getElementById('default-message').classList.remove('d-none');
        document.getElementById('live-mode-btn').classList.replace('btn-outline-secondary', 'btn-primary');
        document.getElementById('upload-mode-btn').classList.replace('btn-primary', 'btn-outline-primary');
        document.getElementById('start-detection-btn').innerHTML = '<i class="fas fa-play me-1"></i>Start Detection';
    }
    
    handleImageUpload(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const canvas = document.getElementById('detection-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                document.getElementById('upload-area').classList.add('d-none');
                document.getElementById('detection-canvas').classList.remove('d-none');
                document.getElementById('process-btn').disabled = false;
                
                // Store image data for processing
                this.currentImageData = e.target.result;
            };
            
            img.src = e.target.result;
        };
        
        reader.readAsDataURL(file);
    }
    
    async processUploadedImage() {
        if (!this.currentImageData) return;
        
        this.showProcessing(true);
        
        try {
            const response = await fetch('/detection/api/process-image/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    image: this.currentImageData,
                    confidence: this.confidenceThreshold
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                this.displayDetectionResults(result);
                this.drawBoundingBoxes(result.detections);
            } else {
                this.showError(result.message || 'Detection failed');
            }
        } catch (error) {
            console.error('Detection error:', error);
            this.showError('Network error occurred');
        } finally {
            this.showProcessing(false);
        }
    }
    
    startLiveDetection() {
        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
            this.websocket.send(JSON.stringify({
                command: 'start_detection',
                confidence: this.confidenceThreshold
            }));
        }
    }
    
    stopLiveDetection() {
        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
            this.websocket.send(JSON.stringify({
                command: 'stop_detection'
            }));
        }
    }
    
    onDetectionStarted(data) {
        document.getElementById('start-detection-btn').disabled = true;
        document.getElementById('stop-detection-btn').disabled = false;
        document.getElementById('detection-status').textContent = 'ACTIVE';
        document.getElementById('detection-status').className = 'badge bg-success';
        this.isLiveDetection = true;
    }
    
    onDetectionStopped(data) {
        document.getElementById('start-detection-btn').disabled = false;
        document.getElementById('stop-detection-btn').disabled = true;
        document.getElementById('detection-status').textContent = 'STOPPED';
        document.getElementById('detection-status').className = 'badge bg-secondary';
        this.isLiveDetection = false;
    }
    
    updateDetectionResults(data) {
        // Update statistics
        document.getElementById('objects-count').textContent = data.total_count;
        document.getElementById('priority-count').textContent = data.high_priority_count;
        
        // Update recent detections list
        this.updateDetectionsList(data.detections);
    }
    
    updateDetectionsList(detections) {
        const listContainer = document.querySelector('.detection-list');
        listContainer.innerHTML = '';
        
        detections.slice(0, 4).forEach(detection => {
            const item = document.createElement('div');
            item.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded';
            
            const priorityClass = detection.is_high_priority ? 'text-danger' : 'text-info';
            const confidencePercent = Math.round(detection.confidence * 100);
            
            item.innerHTML = `
                <div>
                    <small class="fw-bold ${priorityClass}">${detection.class_name}</small><br>
                    <small class="text-muted">Conf: ${confidencePercent}%</small>
                </div>
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
            `;
            
            listContainer.appendChild(item);
        });
    }
    
    drawBoundingBoxes(detections) {
        const overlay = document.getElementById('detection-overlay');
        overlay.innerHTML = '';
        
        const container = document.querySelector('.detection-container');
        const containerRect = container.getBoundingClientRect();
        
        detections.forEach(detection => {
            const box = document.createElement('div');
            box.className = 'position-absolute border';
            box.style.cssText = `
                left: ${detection.bbox[0]}px;
                top: ${detection.bbox[1]}px;
                width: ${detection.bbox[2] - detection.bbox[0]}px;
                height: ${detection.bbox[3] - detection.bbox[1]}px;
                border-color: ${detection.is_high_priority ? '#dc3545' : '#0d6efd'} !important;
                border-width: 2px;
            `;
            
            // Add label
            const label = document.createElement('div');
            label.className = 'position-absolute bg-primary text-white px-2 py-1 small';
            label.style.top = '-25px';
            label.textContent = `${detection.class_name}: ${Math.round(detection.confidence * 100)}%`;
            
            box.appendChild(label);
            overlay.appendChild(box);
        });
    }
    
    displayDetectionResults(result) {
        // Update statistics cards
        document.getElementById('objects-count').textContent = result.total_detections;
        document.getElementById('priority-count').textContent = result.high_priority_objects;
        
        // Show success message
        const message = `Detected ${result.total_detections} objects in ${result.processing_time}s`;
        this.showSuccess(message);
    }
    
    async switchModel(modelPath) {
        try {
            const response = await fetch('/detection/api/switch-model/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ model_path: modelPath })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                this.showSuccess(`Switched to model: ${modelPath}`);
            } else {
                this.showError(result.message || 'Failed to switch model');
            }
        } catch (error) {
            console.error('Model switch error:', error);
            this.showError('Failed to switch model');
        }
    }
    
    showProcessing(show) {
        const indicator = document.getElementById('processing-indicator');
        if (show) {
            indicator.classList.remove('d-none');
        } else {
            indicator.classList.add('d-none');
        }
    }
    
    showError(message) {
        // You can implement a toast notification system here
        console.error('Detection Error:', message);
        alert('Error: ' + message);
    }
    
    showSuccess(message) {
        // You can implement a toast notification system here
        console.log('Detection Success:', message);
    }
    
    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
}

// Initialize the detection system when the page loads
document.addEventListener('DOMContentLoaded', function() {
    window.vihangamDetection = new VihangamDetection();
});
</script>
{% endblock %}