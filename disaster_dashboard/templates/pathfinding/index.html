{% extends 'base.html' %}

{% block title %}Pathfinding - Vihangam Navigation System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="display-6 fw-bold text-primary">
                    <i class="fas fa-route me-2"></i>Autonomous Navigation System
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="calculate-path-btn">
                        <i class="fas fa-calculator me-1"></i>Calculate Path
                    </button>
                    <button class="btn btn-primary" id="start-navigation-btn">
                        <i class="fas fa-play me-1"></i>Start Navigation
                    </button>
                    <button class="btn btn-danger" id="emergency-return-btn">
                        <i class="fas fa-home me-1"></i>Emergency Return
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Current Distance</h6>
                            <h2 class="fw-bold">2.4 km</h2>
                            <small><i class="fas fa-map-marker-alt me-1"></i>To destination</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-ruler fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">ETA</h6>
                            <h2 class="fw-bold">12 min</h2>
                            <small><i class="fas fa-clock me-1"></i>At current speed</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hourglass-half fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Obstacles</h6>
                            <h2 class="fw-bold">3</h2>
                            <small><i class="fas fa-exclamation-triangle me-1"></i>Detected ahead</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Path Efficiency</h6>
                            <h2 class="fw-bold">92%</h2>
                            <small><i class="fas fa-check me-1"></i>Optimal route</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Navigation Content -->
    <div class="row">
        <!-- Interactive Map -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map me-2"></i>Flight Path Visualization
                    </h5>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge bg-info" id="navigation-status">PLANNING</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" id="satellite-view">Satellite</button>
                            <button class="btn btn-outline-primary active" id="terrain-view">Terrain</button>
                            <button class="btn btn-outline-primary" id="hybrid-view">Hybrid</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="map-container bg-light position-relative" style="height: 500px;" id="map-container">
                        <!-- Dynamic path visualization will be rendered here -->
                        <div id="path-visualization" class="position-absolute top-0 start-0 w-100 h-100"></div>
                        
                        <!-- Loading indicator -->
                        <div id="path-loading" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Calculating path...</span>
                            </div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">Calculating optimal path...</small>
                            </div>
                        </div>
                        
                        <!-- Map Legend -->
                        <div class="position-absolute bottom-0 start-0 m-3">
                            <div class="bg-white p-2 rounded shadow-sm">
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <small>Start Point</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <small>Destination</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-primary rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <small>Current Position</small>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <small>Waypoints</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="bg-dark rounded me-2" style="width: 12px; height: 12px;"></div>
                                    <small>Obstacles</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Control Panel -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>Navigation Control
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Waypoint Management -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Waypoint Management</h6>
                        <div class="mb-2">
                            <label class="form-label">Start Coordinates</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="text" id="start-lat" class="form-control form-control-sm" placeholder="Start Latitude" value="28.6139">
                                </div>
                                <div class="col-6">
                                    <input type="text" id="start-lng" class="form-control form-control-sm" placeholder="Start Longitude" value="77.2090">
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Destination Coordinates</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="text" id="dest-lat" class="form-control form-control-sm" placeholder="Destination Latitude" value="28.6200">
                                </div>
                                <div class="col-6">
                                    <input type="text" id="dest-lng" class="form-control form-control-sm" placeholder="Destination Longitude" value="77.2150">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-plus me-1"></i>Add Waypoint
                        </button>
                    </div>

                    <!-- Algorithm Settings -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Algorithm Settings</h6>
                        <div class="mb-2">
                            <label class="form-label">Pathfinding Algorithm</label>
                            <select id="algorithm-select" class="form-select form-select-sm">
                                <option value="astar_grid" selected>A* Grid-Based</option>
                                <option value="astar">A* GPS-Based</option>
                                <option value="simple">Simple A*</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Movement Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="movement" id="movement-8dir" value="true" checked>
                                <label class="form-check-label" for="movement-8dir">8-Directional (includes diagonals)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="movement" id="movement-4dir" value="false">
                                <label class="form-check-label" for="movement-4dir">4-Directional (N,S,E,W only)</label>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Optimization Priority</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priority" id="shortest-path" value="shortest" checked>
                                <label class="form-check-label" for="shortest-path">Shortest Path</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priority" id="safest-path" value="safest">
                                <label class="form-check-label" for="safest-path">Safest Route</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priority" id="fastest-path" value="fastest">
                                <label class="form-check-label" for="fastest-path">Fastest Route</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="priority" id="battery-optimal" value="battery_optimal">
                                <label class="form-check-label" for="battery-optimal">Battery Optimal</label>
                            </div>
                        </div>
                    </div>

                    <!-- Flight Parameters -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Flight Parameters</h6>
                        <div class="mb-2">
                            <label class="form-label">Cruise Altitude</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1 me-2" id="altitude-slider" min="50" max="500" value="150">
                                <span class="badge bg-secondary" id="altitude-value">150m</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Max Speed</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1 me-2" id="speed-slider" min="5" max="25" value="12">
                                <span class="badge bg-secondary" id="speed-value">12 m/s</span>
                            </div>
                        </div>
                    </div>

                    <!-- Safety Settings -->
                    <div class="mb-4">
                        <h6 class="fw-bold">Safety Settings</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="obstacle-avoidance" checked>
                            <label class="form-check-label" for="obstacle-avoidance">Dynamic Obstacle Avoidance</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="weather-routing" checked>
                            <label class="form-check-label" for="weather-routing">Weather-Based Routing</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="no-fly-zones" checked>
                            <label class="form-check-label" for="no-fly-zones">Respect No-Fly Zones</label>
                        </div>
                    </div>

                    <!-- Path Statistics -->
                    <div>
                        <h6 class="fw-bold">Path Statistics</h6>
                        <div class="bg-light p-3 rounded" id="path-stats">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Distance:</span>
                                <span class="fw-bold" id="stat-distance">--</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Flight Time:</span>
                                <span class="fw-bold" id="stat-time">--</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Battery Usage:</span>
                                <span class="fw-bold" id="stat-battery">--</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Safety Score:</span>
                                <span class="fw-bold" id="stat-safety">--</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Waypoints:</span>
                                <span class="fw-bold" id="stat-waypoints">--</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Algorithm:</span>
                                <span class="fw-bold" id="stat-algorithm">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Log -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Navigation Log
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Event</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>18:04:15</td>
                                    <td>Path Recalculation</td>
                                    <td>28.6140°N, 77.2091°E</td>
                                    <td><span class="badge bg-warning">Processing</span></td>
                                    <td>Obstacle detected, recalculating route</td>
                                </tr>
                                <tr>
                                    <td>18:03:42</td>
                                    <td>Waypoint Reached</td>
                                    <td>28.6141°N, 77.2092°E</td>
                                    <td><span class="badge bg-success">Complete</span></td>
                                    <td>Waypoint #1 reached successfully</td>
                                </tr>
                                <tr>
                                    <td>18:02:18</td>
                                    <td>Course Correction</td>
                                    <td>28.6139°N, 77.2090°E</td>
                                    <td><span class="badge bg-info">Complete</span></td>
                                    <td>Wind compensation applied</td>
                                </tr>
                                <tr>
                                    <td>18:00:00</td>
                                    <td>Navigation Started</td>
                                    <td>28.6139°N, 77.2090°E</td>
                                    <td><span class="badge bg-success">Complete</span></td>
                                    <td>A* pathfinding algorithm initiated</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- D3.js for path visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    // Pathfinding specific JavaScript with backend integration
    document.addEventListener('DOMContentLoaded', function() {
        const calculateBtn = document.getElementById('calculate-path-btn');
        const startNavBtn = document.getElementById('start-navigation-btn');
        const emergencyBtn = document.getElementById('emergency-return-btn');
        const statusBadge = document.getElementById('navigation-status');
        const altitudeSlider = document.getElementById('altitude-slider');
        const altitudeValue = document.getElementById('altitude-value');
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        
        // Path visualization variables
        let currentPath = null;
        let svg = null;
        let currentStats = null;
        
        // Initialize D3 visualization
        function initializeVisualization() {
            const container = document.getElementById('path-visualization');
            const containerRect = container.getBoundingClientRect();
            
            // Clear existing SVG
            d3.select(container).selectAll('svg').remove();
            
            // Create SVG canvas
            svg = d3.select(container)
                .append('svg')
                .attr('width', containerRect.width)
                .attr('height', containerRect.height)
                .style('position', 'absolute')
                .style('top', '0')
                .style('left', '0');
                
            // Add grid pattern background
            const defs = svg.append('defs');
            const pattern = defs.append('pattern')
                .attr('id', 'grid')
                .attr('width', 40)
                .attr('height', 40)
                .attr('patternUnits', 'userSpaceOnUse');
                
            pattern.append('path')
                .attr('d', 'M 40 0 L 0 0 0 40')
                .attr('fill', 'none')
                .attr('stroke', 'rgba(0,0,0,0.1)')
                .attr('stroke-width', 1);
                
            // Add grid background
            svg.append('rect')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('fill', 'url(#grid)');
        }
        
        // Visualize path using D3.js
        function visualizePath(pathData) {
            if (!svg || !pathData) return;
            
            // Clear previous path elements
            svg.selectAll('.path-element').remove();
            
            const containerRect = svg.node().getBoundingClientRect();
            const width = containerRect.width;
            const height = containerRect.height;
            
            let coordinates = [];
            
            // Handle different path data formats
            if (pathData.grid_path) {
                // Grid-based path - convert grid coordinates to screen coordinates
                const gridSize = Math.sqrt(pathData.grid_path.length * 4); // Estimate grid size
                coordinates = pathData.grid_path.map(([x, y]) => ({
                    x: (x / Math.max(gridSize, 10)) * width * 0.8 + width * 0.1,
                    y: (y / Math.max(gridSize, 10)) * height * 0.8 + height * 0.1,
                    grid: [x, y]
                }));
            } else if (pathData.path || pathData.gps_path) {
                // GPS-based path - use relative positioning
                const pathCoords = pathData.path || pathData.gps_path;
                coordinates = pathCoords.map((coord, i) => ({
                    x: (i / Math.max(pathCoords.length - 1, 1)) * width * 0.8 + width * 0.1,
                    y: height * 0.2 + (i % 3) * height * 0.2, // Staggered Y positions
                    coord: coord
                }));
            }
            
            if (coordinates.length === 0) return;
            
            // Draw path line
            const line = d3.line()
                .x(d => d.x)
                .y(d => d.y)
                .curve(d3.curveCardinal);
                
            svg.append('path')
                .datum(coordinates)
                .attr('class', 'path-element path-line')
                .attr('d', line)
                .attr('stroke', '#007bff')
                .attr('stroke-width', 3)
                .attr('fill', 'none')
                .attr('stroke-dasharray', '10,5')
                .style('opacity', 0)
                .transition()
                .duration(1000)
                .style('opacity', 1);
            
            // Draw waypoints
            svg.selectAll('.waypoint')
                .data(coordinates)
                .enter()
                .append('circle')
                .attr('class', 'path-element waypoint')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', (d, i) => {
                    if (i === 0) return 20; // Start point
                    if (i === coordinates.length - 1) return 20; // End point
                    return 12; // Waypoints
                })
                .attr('fill', (d, i) => {
                    if (i === 0) return '#28a745'; // Green for start
                    if (i === coordinates.length - 1) return '#dc3545'; // Red for end
                    return '#ffc107'; // Yellow for waypoints
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .style('opacity', 0)
                .transition()
                .duration(1000)
                .delay((d, i) => i * 100)
                .style('opacity', 1);
                
            // Add labels
            svg.selectAll('.waypoint-label')
                .data(coordinates)
                .enter()
                .append('text')
                .attr('class', 'path-element waypoint-label')
                .attr('x', d => d.x)
                .attr('y', d => d.y - 25)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .text((d, i) => {
                    if (i === 0) return 'START';
                    if (i === coordinates.length - 1) return 'DEST';
                    return `W${i}`;
                })
                .style('opacity', 0)
                .transition()
                .duration(1000)
                .delay((d, i) => i * 100 + 500)
                .style('opacity', 1);
                
            // Add animated drone (if navigating)
            if (statusBadge.textContent === 'READY' || statusBadge.textContent === 'NAVIGATING') {
                svg.append('circle')
                    .attr('class', 'path-element drone-position')
                    .attr('cx', coordinates[0].x)
                    .attr('cy', coordinates[0].y)
                    .attr('r', 15)
                    .attr('fill', '#007bff')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 3);
                    
                svg.append('text')
                    .attr('class', 'path-element drone-icon')
                    .attr('x', coordinates[0].x)
                    .attr('y', coordinates[0].y + 5)
                    .attr('text-anchor', 'middle')
                    .attr('font-family', 'FontAwesome')
                    .attr('font-size', '16px')
                    .attr('fill', '#fff')
                    .text('\uf533'); // Helicopter icon
            }
        }
        
        // Update path statistics
        function updatePathStats(data) {
            currentStats = data;
            
            // Update distance
            const distance = data.distance || data.distance_km || data.total_distance || '--';
            document.getElementById('stat-distance').textContent = 
                typeof distance === 'number' ? distance.toFixed(2) + ' km' : distance;
            
            // Update time
            const time = data.flight_time || data.flight_time_minutes || data.total_time || '--';
            document.getElementById('stat-time').textContent = 
                typeof time === 'number' ? time.toFixed(1) + ' min' : time;
            
            // Update battery
            const battery = data.battery_usage || data.battery_usage_percent || '--';
            document.getElementById('stat-battery').textContent = 
                typeof battery === 'number' ? battery.toFixed(1) + '%' : battery;
                
            // Update safety score
            const safety = data.safety_score || '--';
            document.getElementById('stat-safety').textContent = 
                typeof safety === 'number' ? safety.toFixed(1) + '/100' : safety;
            
            // Update waypoints
            const waypoints = data.path_length || (data.path && data.path.length) || 
                            (data.waypoints && data.waypoints.length) || '--';
            document.getElementById('stat-waypoints').textContent = waypoints;
            
            // Update algorithm
            const algorithm = data.algorithm || data.algorithm_used || '--';
            document.getElementById('stat-algorithm').textContent = algorithm;
        }
        
        // Get form data
        function getFormData() {
            return {
                start_lat: parseFloat(document.getElementById('start-lat').value),
                start_lng: parseFloat(document.getElementById('start-lng').value),
                dest_lat: parseFloat(document.getElementById('dest-lat').value),
                dest_lng: parseFloat(document.getElementById('dest-lng').value),
                algorithm: document.getElementById('algorithm-select').value,
                use_8_dir: document.querySelector('input[name="movement"]:checked').value === 'true',
                priority: document.querySelector('input[name="priority"]:checked').value,
                altitude: parseInt(document.getElementById('altitude-slider').value),
                max_speed: parseInt(document.getElementById('speed-slider').value),
                avoid_obstacles: document.getElementById('obstacle-avoidance').checked,
                smooth_path: true,
                grid_size: 10
            };
        }
        
        // Calculate path using backend API
        calculateBtn.addEventListener('click', function() {
            statusBadge.textContent = 'CALCULATING';
            statusBadge.className = 'badge bg-warning';
            calculateBtn.disabled = true;
            
            // Show loading indicator
            document.getElementById('path-loading').classList.remove('d-none');
            
            const formData = getFormData();
            
            // Choose the appropriate endpoint based on algorithm
            let endpoint = '/pathfinding/calculate-path/';
            if (formData.algorithm === 'simple') {
                endpoint = '/pathfinding/calculate-path-simple/';
            } else if (formData.algorithm === 'astar_grid') {
                endpoint = '/pathfinding/calculate-path/';
            }
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                document.getElementById('path-loading').classList.add('d-none');
                
                if (data.status === 'success') {
                    statusBadge.textContent = 'READY';
                    statusBadge.className = 'badge bg-success';
                    calculateBtn.disabled = false;
                    startNavBtn.disabled = false;
                    
                    // Store and visualize path
                    currentPath = data;
                    visualizePath(data);
                    updatePathStats(data);
                    
                    // Log success
                    console.log('Path calculated successfully:', data);
                } else {
                    statusBadge.textContent = 'ERROR';
                    statusBadge.className = 'badge bg-danger';
                    calculateBtn.disabled = false;
                    
                    alert('Error calculating path: ' + (data.message || 'Unknown error'));
                    console.error('Path calculation error:', data);
                }
            })
            .catch(error => {
                // Hide loading indicator
                document.getElementById('path-loading').classList.add('d-none');
                
                statusBadge.textContent = 'ERROR';
                statusBadge.className = 'badge bg-danger';
                calculateBtn.disabled = false;
                
                alert('Network error: ' + error.message);
                console.error('Network error:', error);
            });
        });
        
        // Start navigation
        startNavBtn.addEventListener('click', function() {
            if (!currentPath) {
                alert('Please calculate a path first!');
                return;
            }
            
            statusBadge.textContent = 'NAVIGATING';
            statusBadge.className = 'badge bg-primary';
            startNavBtn.disabled = true;
            calculateBtn.disabled = true;
            
            // Make API call to start navigation
            fetch('/pathfinding/start-navigation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    path_id: currentPath.path_id || 'current_path'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Navigation started:', data);
                    // Could add drone animation here
                } else {
                    alert('Failed to start navigation: ' + data.message);
                    statusBadge.textContent = 'READY';
                    statusBadge.className = 'badge bg-success';
                    startNavBtn.disabled = false;
                    calculateBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Navigation start error:', error);
                statusBadge.textContent = 'READY';
                statusBadge.className = 'badge bg-success';
                startNavBtn.disabled = false;
                calculateBtn.disabled = false;
            });
        });
        
        // Emergency return
        emergencyBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to initiate emergency return to base?')) {
                statusBadge.textContent = 'RETURNING';
                statusBadge.className = 'badge bg-danger';
                startNavBtn.disabled = true;
                calculateBtn.disabled = true;
                
                fetch('/pathfinding/emergency-return/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Emergency return activated:', data);
                })
                .catch(error => {
                    console.error('Emergency return error:', error);
                });
            }
        });
        
        // Slider updates
        altitudeSlider.addEventListener('input', function() {
            altitudeValue.textContent = this.value + 'm';
        });
        
        speedSlider.addEventListener('input', function() {
            speedValue.textContent = this.value + ' m/s';
        });
        
        // Initialize visualization on page load
        initializeVisualization();
        
        // Reinitialize on window resize
        window.addEventListener('resize', function() {
            setTimeout(initializeVisualization, 100);
            if (currentPath) {
                setTimeout(() => visualizePath(currentPath), 200);
            }
        });
    });
</script>

<style>
    .animate-drone {
        transition: all 1s ease-in-out;
    }
    
    .map-container {
        background-color: #f8f9fa;
    }
    
    .form-range::-webkit-slider-thumb {
        background: #007bff;
    }
    
    .form-range::-moz-range-thumb {
        background: #007bff;
        border: none;
    }
</style>
{% endblock %}